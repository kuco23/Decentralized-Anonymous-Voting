# Decentralized Anonymous Voting

This is a simple implementation of a decentralized anonymous voting system, based on the main idea of zerocash, using zk-snarks.
The voting system requires voters to be predefined and makes the voting results publicly known at all times without revealing voter choices.

> **Note:**
> Zerocash implements a decentralized anonymous currency by making use of zk-snarks to transfer an unknown coin to an unknown recipients by nullifying the coin and making a new one that follows a correct format. Here we only nullify the unknown coin (called a ticket), which acts as casting a vote.

The implementation relies heavily on the poseidon hash function,
which has a circuit optimized for zk-snark construction.

## Voting flow

The voting flow follows the below description:
- a user [deploys the voting contract](#Deployment-of-the-voting-contract) by specifying the voter addresses, along with the voting duration;
- before the voting period, voters [register tickets](#Registering-tickets) to the smart contract;
- during the voting period, voters vote for an option by spending their tickets in a zero-knowledge way, which is done by [producing](#Constructing-zk-snark) and sending a zk-snark to the contract;
- after the voting period the winner is considered fixed.

### Deployment of the voting contract

There are two contracts that should be deployed to establish the voting system:
- `TicketSpender.sol` verifies zk-snarks,
- `AnonymousVoting.sol` implements the voting system and uses `TicketSpender` to verify whether ticket spending is valid.

The second contract should be deployed with specified `TicketSpender` address, a list of voter addresses and the voting duration. The second sets of arguments are poseidon hash function constants, that are specified in the tests.

### Registering tickets

To register a spendable ticket, you should choose a vote option, generate a secret 256-bit number and hash those as `poseidon(secret, option)`. For later use, you should also produce its serial number `poseidon(secret, ticket)`.

### Constructing zk-snark

The construction of zk-snark is generated by circom and snarkjs
from the circuits defined in the circuits folder. To use those, you should generate a one-time trusted setup by downloading [this](https://hermez.s3-eu-west-1.amazonaws.com/powersOfTau28_hez_final_16.ptau) file into the root folder and then run `generate-setup.sh`. 

To construct the necessary zk-snark, follow the steps below:
- call the `AnonymousVoting` contract's `getTickets` view function
to obtain all tickets and from them construct the merkle tree. From that tree obtain the merkle root and construct the merkle proof of your ticket being inside. The following elements are then responsible for generating the zk-snark:
    - your vote option,
    - your ticket's serial number,
    - merkle root,
    - your ticket,
    - your secret,
    - merkle proof
    
    and should be pasted into `snark_data/input.json`. To auto-generate those values from the merkle tree and your secret number, use `generate_input.py`. 
- run `generate-proof.sh` to obtain the values, necessary to make the contract call.

Detailed `input.json` production is done below in Python:
```python
from random import getrandbits
from pyutil import (
    poseidon, getWitnessArguments,
    createCircomInputJson
)

TREE_DEPTH = 21

# define personal input values
option = 10 # must be int
secret = getrandbits(256)

# construct the voting ticket
ticket = poseidon(secret, option)

# fetch all voting tickets from by making
# a view call to the smart contract
tickets = [111, 222, 333, ticket, 444, 555]

# get arguments for witness generation
witness_args = getWitnessArguments(
    option, secret, tickets, TREE_DEPTH)

# generate circom input
createCircomInputJson(**witness_args)
```

## Testing
To generate the necessary files, you should paste [this](https://hermez.s3-eu-west-1.amazonaws.com/powersOfTau28_hez_final_16.ptau) into the root folder, then run:
```sh
sh generate-setup.sh
python3 generate-input.py
sh generate-proof.sh
```
Now you can run the tests as
```sh
yarn test tests/*
```

## To-do
- [ ] Find a way to hardcode poseidon constants in the `AnonymousVoting` contract and use them to initialise `Poseidon`,
- [ ] Find a way for `AnonymousVoting` to inherit `TicketSpender` without `verifyProof` blocking the following code execution.